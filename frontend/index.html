<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SNOTEL Basin Index | Water Risk Monitor</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-primary: #0a0f1a;
            --bg-secondary: #111827;
            --bg-tertiary: #1f2937;
            --text-primary: #f9fafb;
            --text-secondary: #9ca3af;
            --text-muted: #6b7280;
            --accent-cyan: #06b6d4;
            --accent-blue: #3b82f6;
            --border-color: #374151;
            --critical: #dc2626;
            --low: #f97316;
            --below-normal: #eab308;
            --normal: #22c55e;
            --above-normal: #06b6d4;
            --high: #8b5cf6;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Header */
        header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .logo-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-blue));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .logo-icon svg {
            width: 20px;
            height: 20px;
            fill: white;
        }
        
        .logo h1 {
            font-size: 1.25rem;
            font-weight: 600;
            background: linear-gradient(135deg, var(--text-primary), var(--accent-cyan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        /* Controls */
        .controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .date-control {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--bg-tertiary);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        
        .date-control label {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        .date-control input {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.375rem 0.75rem;
            border-radius: 6px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
        }
        
        .date-control input:focus {
            outline: none;
            border-color: var(--accent-cyan);
        }
        
        .btn {
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-blue));
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: opacity 0.2s, transform 0.2s;
        }
        
        .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Main Content */
        main {
            flex: 1;
            display: flex;
            position: relative;
        }
        
        #map {
            flex: 1;
            background: var(--bg-primary);
        }
        
        /* Sidebar */
        .sidebar {
            width: 320px;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .sidebar-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        .sidebar-header h2 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        
        .sidebar-header p {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        .stat-card {
            background: var(--bg-tertiary);
            padding: 0.75rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }
        
        /* Legend */
        .legend {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        .legend h3 {
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
        }
        
        .legend-items {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
        }
        
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.2);
        }
        
        /* Station List */
        .station-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }
        
        .station-item {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: background 0.2s, transform 0.2s;
            border-left: 3px solid transparent;
        }
        
        .station-item:hover {
            background: var(--bg-primary);
            transform: translateX(2px);
        }
        
        .station-item.critical { border-left-color: var(--critical); }
        .station-item.low { border-left-color: var(--low); }
        .station-item.below-normal { border-left-color: var(--below-normal); }
        .station-item.normal { border-left-color: var(--normal); }
        .station-item.above-normal { border-left-color: var(--above-normal); }
        .station-item.high { border-left-color: var(--high); }
        
        .station-name {
            font-weight: 500;
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
        }
        
        .station-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        
        .basin-index {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
        }
        
        /* Loading State */
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            z-index: 1000;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-cyan);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Leaflet Customization */
        .leaflet-container {
            background: var(--bg-primary);
        }
        
        .leaflet-popup-content-wrapper {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        
        .leaflet-popup-tip {
            background: var(--bg-secondary);
        }
        
        .leaflet-popup-content {
            margin: 0;
            min-width: 220px;
        }
        
        .popup-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        .popup-header h3 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        
        .popup-header p {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        
        .popup-body {
            padding: 1rem;
        }
        
        .popup-stat {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .popup-stat:last-child {
            border-bottom: none;
        }
        
        .popup-stat-label {
            color: var(--text-secondary);
            font-size: 0.8rem;
        }
        
        .popup-stat-value {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 500;
        }
        
        .popup-basin-index {
            text-align: center;
            padding: 1rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        
        .popup-basin-value {
            font-size: 2rem;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .popup-basin-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        
        /* State filter */
        .state-filter {
            display: flex;
            gap: 0.5rem;
        }
        
        .state-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 0.375rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .state-btn:hover, .state-btn.active {
            background: var(--accent-cyan);
            border-color: var(--accent-cyan);
            color: white;
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">
            <div class="logo-icon">
                <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
            </div>
            <h1>Water Risk Monitor</h1>
        </div>
        
        <div class="controls">
            <div class="state-filter">
                <button class="state-btn active" data-state="all">All</button>
                <button class="state-btn" data-state="CA">CA</button>
                <button class="state-btn" data-state="ID">ID</button>
                <button class="state-btn" data-state="NV">NV</button>
                <button class="state-btn" data-state="OR">OR</button>
                <button class="state-btn" data-state="WA">WA</button>
            </div>
            
            <div class="date-control">
                <label for="date-picker">Date:</label>
                <input type="date" id="date-picker" />
            </div>
            
            <button class="btn" id="load-btn">Load Data</button>
        </div>
    </header>
    
    <main>
        <div id="map"></div>
        
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>SNOTEL Basin Index</h2>
                <p id="data-date">Loading...</p>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="stat-stations">--</div>
                    <div class="stat-label">Stations</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-avg">--</div>
                    <div class="stat-label">Avg Index</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-min">--</div>
                    <div class="stat-label">Min Index</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-max">--</div>
                    <div class="stat-label">Max Index</div>
                </div>
            </div>
            
            <div class="legend">
                <h3>Basin Index Legend</h3>
                <div class="legend-items">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #dc2626;"></div>
                        <span>Critical (&lt; 25%)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #f97316;"></div>
                        <span>Low (25-50%)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #eab308;"></div>
                        <span>Below Normal (50-75%)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #22c55e;"></div>
                        <span>Normal (75-125%)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #06b6d4;"></div>
                        <span>Above Normal (125-150%)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #8b5cf6;"></div>
                        <span>High (&gt; 150%)</span>
                    </div>
                </div>
            </div>
            
            <div class="station-list" id="station-list">
                <!-- Stations will be populated here -->
            </div>
        </aside>
        
        <div class="loading" id="loading" style="display: none;">
            <div class="spinner"></div>
            <span>Loading data...</span>
        </div>
    </main>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // Configuration
        const API_URL = 'http://localhost:8000/api';
        
        // Map setup
        const map = L.map('map', {
            center: [43.5, -120],
            zoom: 6,
            zoomControl: true,
        });
        
        // Dark tile layer
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> &copy; <a href="https://carto.com/attributions">CARTO</a>',
            maxZoom: 19
        }).addTo(map);
        
        // State
        let stationsLayer = null;
        let currentData = [];
        let selectedState = 'all';
        
        // Color scale
        function getColor(basinIndex) {
            if (basinIndex === null || basinIndex === undefined) return '#6b7280';
            if (basinIndex < 25) return '#dc2626';
            if (basinIndex < 50) return '#f97316';
            if (basinIndex < 75) return '#eab308';
            if (basinIndex < 125) return '#22c55e';
            if (basinIndex < 150) return '#06b6d4';
            return '#8b5cf6';
        }
        
        function getConditionClass(basinIndex) {
            if (basinIndex === null || basinIndex === undefined) return 'no-data';
            if (basinIndex < 25) return 'critical';
            if (basinIndex < 50) return 'low';
            if (basinIndex < 75) return 'below-normal';
            if (basinIndex < 125) return 'normal';
            if (basinIndex < 150) return 'above-normal';
            return 'high';
        }
        
        // Create popup content
        function createPopupContent(station) {
            const basinIndex = station.basin_index;
            const color = getColor(basinIndex);
            const basinStr = basinIndex !== null ? `${basinIndex.toFixed(0)}%` : 'N/A';
            
            return `
                <div class="popup-header">
                    <h3>${station.station_name || station.name}</h3>
                    <p>${station.state_code} Â· ${station.county_name || 'Unknown County'}</p>
                </div>
                <div class="popup-body">
                    <div class="popup-basin-index">
                        <div class="popup-basin-value" style="color: ${color}">${basinStr}</div>
                        <div class="popup-basin-label">Basin Index</div>
                    </div>
                    <div class="popup-stat">
                        <span class="popup-stat-label">Snow Water Equiv.</span>
                        <span class="popup-stat-value">${station.wteq_value !== null ? station.wteq_value.toFixed(1) + '"' : 'N/A'}</span>
                    </div>
                    <div class="popup-stat">
                        <span class="popup-stat-label">Median</span>
                        <span class="popup-stat-value">${station.wteq_median !== null ? station.wteq_median.toFixed(1) + '"' : 'N/A'}</span>
                    </div>
                    <div class="popup-stat">
                        <span class="popup-stat-label">Snow Depth</span>
                        <span class="popup-stat-value">${station.snow_depth !== null ? station.snow_depth.toFixed(0) + '"' : 'N/A'}</span>
                    </div>
                    <div class="popup-stat">
                        <span class="popup-stat-label">Elevation</span>
                        <span class="popup-stat-value">${station.elevation ? station.elevation.toFixed(0) + ' ft' : 'N/A'}</span>
                    </div>
                    <div class="popup-stat">
                        <span class="popup-stat-label">HUC-12</span>
                        <span class="popup-stat-value">${station.huc || 'N/A'}</span>
                    </div>
                </div>
            `;
        }
        
        // Update station list in sidebar
        function updateStationList(stations) {
            const container = document.getElementById('station-list');
            
            // Sort by basin index (lowest first - most critical)
            const sorted = [...stations].sort((a, b) => {
                if (a.basin_index === null) return 1;
                if (b.basin_index === null) return -1;
                return a.basin_index - b.basin_index;
            });
            
            container.innerHTML = sorted.map(station => {
                const basinIndex = station.basin_index;
                const conditionClass = getConditionClass(basinIndex);
                const basinStr = basinIndex !== null ? `${basinIndex.toFixed(0)}%` : 'N/A';
                
                return `
                    <div class="station-item ${conditionClass}" 
                         data-lat="${station.latitude}" 
                         data-lng="${station.longitude}"
                         onclick="flyToStation(${station.latitude}, ${station.longitude})">
                        <div class="station-name">${station.station_name || station.name}</div>
                        <div class="station-meta">
                            <span>${station.state_code}</span>
                            <span class="basin-index" style="color: ${getColor(basinIndex)}">${basinStr}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Update stats
        function updateStats(stations) {
            const withData = stations.filter(s => s.basin_index !== null);
            
            document.getElementById('stat-stations').textContent = stations.length;
            
            if (withData.length > 0) {
                const avg = withData.reduce((sum, s) => sum + s.basin_index, 0) / withData.length;
                const min = Math.min(...withData.map(s => s.basin_index));
                const max = Math.max(...withData.map(s => s.basin_index));
                
                document.getElementById('stat-avg').textContent = `${avg.toFixed(0)}%`;
                document.getElementById('stat-min').textContent = `${min.toFixed(0)}%`;
                document.getElementById('stat-max').textContent = `${max.toFixed(0)}%`;
            } else {
                document.getElementById('stat-avg').textContent = '--';
                document.getElementById('stat-min').textContent = '--';
                document.getElementById('stat-max').textContent = '--';
            }
        }
        
        // Fly to station on click
        function flyToStation(lat, lng) {
            map.flyTo([lat, lng], 10);
        }
        
        // Load data from API
        async function loadData(date = null) {
            const loading = document.getElementById('loading');
            loading.style.display = 'flex';
            
            try {
                let url = `${API_URL}/observations`;
                if (date) {
                    url += `?date=${date}`;
                }
                if (selectedState !== 'all') {
                    url += (date ? '&' : '?') + `state=${selectedState}`;
                }
                
                const response = await fetch(url);
                const data = await response.json();
                
                currentData = data.features || data;
                
                // Update map
                if (stationsLayer) {
                    map.removeLayer(stationsLayer);
                }
                
                // Process data
                const stations = currentData.map(f => {
                    if (f.geometry) {
                        // GeoJSON format
                        return {
                            ...f.properties,
                            latitude: f.geometry.coordinates[1],
                            longitude: f.geometry.coordinates[0],
                        };
                    }
                    return f;
                });
                
                // Add markers
                const markers = stations.map(station => {
                    const color = getColor(station.basin_index);
                    
                    return L.circleMarker([station.latitude, station.longitude], {
                        radius: 8,
                        fillColor: color,
                        color: '#1f2937',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.9,
                    }).bindPopup(createPopupContent(station), {
                        maxWidth: 300,
                        className: 'custom-popup'
                    });
                });
                
                stationsLayer = L.layerGroup(markers).addTo(map);
                
                // Update sidebar
                updateStationList(stations);
                updateStats(stations);
                
                // Update date display
                const displayDate = date || 'Latest';
                document.getElementById('data-date').textContent = `Data for ${displayDate}`;
                
            } catch (error) {
                console.error('Error loading data:', error);
                alert('Error loading data. Make sure the API server is running.');
            } finally {
                loading.style.display = 'none';
            }
        }
        
        // Event listeners
        document.getElementById('load-btn').addEventListener('click', () => {
            const date = document.getElementById('date-picker').value;
            loadData(date || null);
        });
        
        document.querySelectorAll('.state-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.state-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                selectedState = btn.dataset.state;
                
                const date = document.getElementById('date-picker').value;
                loadData(date || null);
            });
        });
        
        // Set default date to yesterday
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        document.getElementById('date-picker').value = yesterday.toISOString().split('T')[0];
        
        // Initial load
        loadData();
    </script>
</body>
</html>

